# 変更履歴

## 2024-01-15 - 仕様改訂（第3版）

### 追加されたセクション

#### 1. Security / Compliance（セキュリティ・コンプライアンス）

**設計書に追加:**
- **ログポリシー**: 記録してよい情報、マスクする情報を明文化
  - APIキーは常にマスク形式（`key_abc***`）
  - IPアドレスはアプリケーションログには記録しない
  - 構造化JSONログ形式の定義
- **データ保持ポリシー**: 
  - DynamoDB: 価格データ（1時間）、レート制限（1時間）、APIキー（永続）
  - CloudWatch Logs: dev（30日）、staging（60日）、prod（90日）
- **監査ログ**: 認証失敗、設定変更、デプロイなどの記録
- **APIキー運用方針**: 
  - 手動ローテーション前提
  - 失効条件（漏洩疑い、長期未使用）
  - `lastUsedAt`属性の追加推奨

#### 2. Out of Scope（今回の非目標）

**設計書に追加:**
- **価格履歴の保存・提供**: 現在価格のみに特化
- **時系列チャート用の複雑なクエリ**: 計算コストが高い
- **高度なフィルタリング・集計API**: 別サービスで対応
- **ユーザー管理・認証**: 現在はAPIキーのみ

**明確化された設計方針:**
- 現在の設計は「現在価格の高速取得」に最適化
- 履歴データや複雑なクエリは将来的な拡張として検討

#### 3. Future Work / Possible Extensions（将来拡張の方向性）

**設計書に追加:**
- **価格履歴機能**: 別テーブルまたは別サービス（Timestream）で対応
- **ユーザー管理・マルチテナント**: APIキーとユーザー/テナントの紐付け
- **リアルタイム価格更新**: WebSocket APIの追加
- **高度な分析・集計**: 別マイクロサービスとして実装
- **アラート・通知機能**: EventBridgeとSNSを活用

**拡張時の方針:**
- 現在のAPIは「薄いフェッチ層」として維持
- 新機能は別エンドポイントまたは別サービスで追加
- キャッシュ戦略は用途に合わせて再設計

#### 4. API Versioning / Backward Compatibility（APIバージョニング）

**設計書に追加:**
- **基本方針**: 既存バージョンでは破壊的変更を行わない
- **破壊的変更の定義**: フィールド削除、型変更、意味変更など
- **後方互換な変更**: 新フィールド追加、オプショナルパラメータ追加
- **バージョン移行手順**: 並行稼働期間（最低3ヶ月）を設ける
- **初期バージョン**: `/prices`（バージョンなし）、将来的に`/v2/prices`を検討

#### 5. 運用ドキュメント（operations.md）

**新規作成:**
- **アラート通知設定**: Slack、Email、SNS
- **主要なアラート種別と対応手順**:
  1. Lambda Error Rate Alarm（Critical）
  2. 外部APIエラー率アラーム（High）
  3. DynamoDBスロットリングアラーム（High）
  4. API Gateway 5xx Error Rate Alarm（Critical）
  5. API Latency P95 Alarm（Medium）
  6. Lambda Throttle Alarm（High）
- **ロールバック判断基準**: 自動/手動ロールバックの条件
- **よくある問題と対処法**: 外部APIレート制限、ホットパーティションなど
- **エスカレーションフロー**: レベル1（運用）→ レベル2（開発）→ レベル3（マネジメント）

### 追加されたタスク

**タスク22: セキュリティ・コンプライアンスポリシーの実装**
- ログマスキング機能
- CloudWatch Logs保持期間設定
- DynamoDB TTL設定
- APIキー`lastUsedAt`属性
- 監査ログ記録

**タスク23: APIバージョニング対応の準備**
- 将来的なフィールド追加を考慮した設計
- バージョニング戦略の文書化
- 後方互換性テスト

**タスク24: 運用ドキュメントとアラート対応フローの整備**
- operations.mdの共有
- Slack/Email通知設定
- アラート対応訓練

### 設計方針の明確化

**IPアドレスのログ記録:**
- API Gatewayのアクセスログには記録される（オペレーション用途）
- アプリケーションログには記録しない

**ユーザーID:**
- 現在は実装しない
- 将来的にAPIキーとユーザー/テナントを紐付ける可能性

**データ保持期間:**
- 環境ごとに異なる保持期間を設定
- 監査要件に応じて調整可能

**APIバージョニング:**
- 初期は`/prices`（バージョンなし）
- 破壊的変更が必要になったら`/v2/prices`を追加
- 並行稼働期間を設けて段階的に移行

**通知チャネル:**
- Slack + Email（SNS経由）
- 将来的にPagerDuty/Opsgenieも検討

---

## 2024-01-15 - 仕様改訂（第2版）

### 設計方針の明確化

#### CI/CDツールの決定
- **GitHub Actions**を主要なCI/CDツールとして採用
- AWS CodePipelineは代替案として設計書に記載
- 実装タスクはGitHub Actionsベースで進める

#### レスポンス最適化の方針確定
- **JSONキー名は可読性重視**で維持（`symbol`, `price`など）
- キー短縮は採用せず、以下で最適化:
  - 不要フィールドの排除
  - 数値精度の制限
  - gzip圧縮
- フィールド数が限定的（6フィールド）であり、キー短縮の効果は小さい
- gzip圧縮により繰り返されるキー名は効率的に圧縮される

#### 自動ロールバックの具体化
- **CloudWatch Alarms + CodeDeploy**の組み合わせで実装
- トラフィックシフト: Linear10PercentEvery1Minute
- ロールバックトリガー:
  - Lambda Errors > 5% for 2 minutes
  - API Gateway 5xx > 10% for 2 minutes
  - Lambda Throttles > 10 in 1 minute
- GitHub ActionsからSAM deploy → CodeDeployがトラフィック制御とロールバックを実行

---

## 2024-01-15 - 仕様改訂（第1版）

### 追加された要件

#### 要件2の明確化
- **2.3**: レスポンスペイロード最適化の詳細を明文化
  - 不要フィールドの排除
  - 数値精度の制限（価格: 小数点2桁、変動率: 小数点1桁）
  - オプションでJSONキーの短縮
  
- **2.5**: 圧縮条件の明確化
  - Accept-Encodingヘッダーによるgzip圧縮の条件を明示

#### 要件7の拡張
- **7.2**: CI/CDパイプラインの具体化（GitHub ActionsまたはAWS CodePipeline）
- **7.5**: 自動ロールバック機能の追加（ヘルスチェック失敗時）
- **7.6**: ステージング→本番昇格フローの追加
- **7.7**: デプロイプロセスとロールバック手順の文書化要件

### 設計書の拡張

#### ヘルスチェックエンドポイントの詳細化
- DynamoDB接続チェックの実装詳細
- 最終価格更新時刻の確認
- キャッシュ年齢の計算と報告
- 正常時（200）と異常時（503）のレスポンス例

#### レスポンス最適化の詳細化
- ペイロード削減戦略の5つの具体的手法
- レスポンスサイズの具体例（非圧縮/圧縮）
- 圧縮による削減率の目標値（60-70%）

#### CI/CDパイプラインの設計
- GitHub Actionsワークフローの構成
- 開発/ステージング/本番環境へのデプロイフロー
- 自動ロールバックの条件とトリガー
- ロールバック手順の詳細

#### テストポリシーの追加
- 実装完了の定義
- テスト作成のタイミングと順序
- テストカバレッジ目標
- テスト命名規則
- タスク完了チェックリスト

### 実装タスクの追加

#### タスク8の拡張
- レスポンス最適化とペイロード削減の実装
- 数値精度制限ロジック
- オプションのコンパクトモード

#### タスク10の拡張
- ヘルスチェックの詳細な実装要件
- 異常検知時の503レスポンス
- 将来的拡張としての外部APIチェック

#### 新規タスク17-21
- **タスク17**: CI/CDパイプラインの構築
- **タスク18**: ゼロダウンタイムデプロイの設定
- **タスク19**: 自動ロールバック機能の実装
- **タスク20**: ステージング→本番昇格フローの整備
- **タスク21**: テストポリシーとガイドラインの文書化

### 新規ドキュメント

#### CONTRIBUTING.md
- テストポリシーの詳細
- コーディング規約
- プルリクエストプロセス
- デプロイメントプロセス
- トラブルシューティングガイド

### 用語集の拡張
- CI/CD Pipeline
- Zero-Downtime Deployment
- Rollback
- Health Check
- Payload Optimization
- Traffic Shifting

## 実装への影響

### 既存タスクへの影響
- タスク8と10が拡張されましたが、既存の実装計画との互換性は維持されています
- 新規タスク（17-21）は既存タスクの完了後に実施可能

### 整合性の確認
- すべての新規要件は設計書とタスクリストに反映済み
- プロパティテストは既存の15個を維持
- 新規タスクは既存のアーキテクチャと整合

### 推奨される実装順序
1. タスク1-16: コア機能の実装（既存計画通り）
2. タスク17: CI/CDパイプラインの構築
3. タスク18-19: デプロイメント機能の実装
4. タスク20: 昇格フローの整備
5. タスク21: ドキュメント整備

## 次のステップ

1. 改訂された仕様のレビュー
2. タスク1から順次実装開始
3. 各タスク完了時にCONTRIBUTING.mdのチェックリストを使用
4. CI/CDパイプライン構築後、自動デプロイフローを検証
