# 仕様改訂サマリー（第3版）

## 改訂日時
2024-01-15

## 改訂の背景
ユーザーからの要望に基づき、以下の4点を追加：
1. セキュリティ要件（Auth以外）の明文化
2. 将来拡張（価格履歴など）に関する設計の位置づけ
3. 運用Runbook（アラート対応フロー）の雛形作成
4. APIバージョニングと互換性ポリシーの明文化

---

## 主要な変更点

### 1. Security / Compliance セクションの追加

**目的:**
ログ・データ保持・監査の振る舞いを明示して、実装と運用の判断をブレさせない。

**追加内容:**

#### ログポリシー

**記録してよい情報:**
- リクエストID、ステータスコード、処理時間
- タイムスタンプ、エンドポイントパス、HTTPメソッド
- エラーメッセージとスタックトレース
- APIキー識別子（マスク形式: `key_abc***`）
- リクエストされた暗号通貨シンボル

**マスクする情報:**
- APIキーの生値（常にマスク）
- IPアドレス（アプリケーションログには記録しない）
  - API Gatewayログには残るが、オペレーション用途のみ
- ユーザーID（将来実装時）
- 外部APIキー

**ログ形式:**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "uuid-v4",
  "level": "INFO",
  "message": "Price data retrieved successfully",
  "apiKey": "key_abc***",
  "endpoint": "/prices",
  "statusCode": 200,
  "duration": 150
}
```

#### データ保持ポリシー

**DynamoDB:**
| データタイプ | 保持期間 | TTL | 備考 |
|------------|---------|-----|------|
| 価格データ | 1時間 | 有効 | キャッシュ用途 |
| レート制限 | 1時間 | 有効 | 分単位カウンター |
| APIキー | 永続 | 無効 | 明示的削除まで |

**APIキーの拡張:**
- `lastUsedAt`属性を追加推奨
- 長期未使用キー（90日以上）の整理ポリシーを将来策定

**CloudWatch Logs:**
| 環境 | 保持期間 |
|------|---------|
| Development | 30日 |
| Staging | 60日 |
| Production | 90日 |

#### 監査ログ

**最低限残すべきイベント:**
1. 認証関連: 認証失敗、レート制限超過、APIキー有効化/無効化
2. 設定変更: Lambda環境変数、DynamoDB設定、CloudWatch Alarms
3. デプロイ関連: デプロイ開始/完了/失敗、ロールバック
4. システムイベント: 外部API失敗、DynamoDBスロットリング、Lambdaタイムアウト

#### APIキー運用方針

**現在（手動運用）:**
- 暗号学的に安全な乱数生成
- 手動ローテーション前提
- 失効条件: 漏洩疑い、長期未使用（90日以上）

**将来的な拡張:**
- 自動ローテーション機能
- 使用状況ダッシュボード
- 異常アクセスパターン検知
- ユーザー/テナントとの紐付け

---

### 2. Out of Scope と Future Work セクションの追加

**目的:**
「今はやらないこと」と「将来あり得る方向性」を明示し、拡張時に判断しやすくする。

#### Out of Scope（今回の非目標）

**含まれない機能:**
1. **価格履歴の保存・提供**
   - 現在価格のみに特化
   - 過去データは保存しない
   - 理由: スマートウォッチは「現在価格確認」用途

2. **時系列チャート用の複雑なクエリ**
   - 期間指定、テクニカル指標、相関分析
   - 理由: 計算コスト高、Lambda制約、画面サイズ制約

3. **高度なフィルタリング・集計API**
   - 価格範囲フィルタ、ランキング、カテゴリ集計
   - 理由: 別サービス層で実装すべき

4. **ユーザー管理・認証**
   - ユーザー登録、ウォッチリスト、マルチテナント
   - 理由: 現在はAPIキーのみ

**設計方針の明確化:**
- 現在の設計は「現在価格の高速取得」に最適化
- 5分更新頻度は現在価格確認に最適
- シングルテーブル設計は読み取り負荷に最適

#### Future Work（将来拡張の方向性）

**1. 価格履歴機能:**
- 別テーブル（`crypto-watch-history`）または別サービス（Timestream）
- 新エンドポイント: `/prices/{symbol}/history`
- 履歴データは不変なため長期キャッシュ可能（24時間）
- CloudFront CDNでキャッシュ効率向上

**2. ユーザー管理・マルチテナント:**
- APIキーに`tenantId`/`userId`属性を追加
- ユーザーごとのウォッチリスト、設定管理
- OAuth/OIDC統合（Cognito、Auth0）
- JWTトークンベース認証

**3. リアルタイム価格更新（WebSocket）:**
- API Gateway WebSocket API
- 更新頻度を高頻度化（30秒、1分）
- DynamoDBで接続管理
- Lambda関数からプッシュ通知

**4. 高度な分析・集計:**
- 別マイクロサービス（`crypto-watch-analytics`）
- DynamoDB Streams → Kinesis → S3/Redshift
- Athenaで複雑なクエリ
- 新エンドポイント: `/analytics/*`

**5. アラート・通知:**
- EventBridgeでイベント発行
- ユーザー定義ルール（例: BTC > $50,000）
- プッシュ通知（FCM、APNs）、Email、SMS

---

### 3. 運用ドキュメント（operations.md）の新規作成

**目的:**
アラート発生時に、人/AIが迷わず切り分け・対応できるようにする。

**構成:**

#### アラート通知設定
- **Slackチャネル**: `#crypto-watch-alerts`, `#crypto-watch-deploys`, `#crypto-watch-incidents`
- **Email**: SNS経由でCritical/High severity
- **将来的拡張**: PagerDuty/Opsgenie

#### 主要なアラート種別と対応手順

**1. Lambda Error Rate Alarm（Critical）**
- 閾値: エラー率 > 5% for 2分
- 確認メトリクス: `AWS/Lambda > Errors`, `Invocations`, `Duration`
- 確認ログ: `/aws/lambda/crypto-watch-api-function`
- 初動対応:
  1. アラーム状態確認
  2. エラーログ確認
  3. エラー分類（外部API、DynamoDB、コードバグ）
  4. 影響範囲確認
  5. 対応判断（ロールバック、調査、待機）

**2. 外部APIエラー率アラーム（High）**
- 閾値: 失敗率 > 50% for 10分
- 確認メトリクス: `Custom/CryptoWatch > ExternalApiErrors`
- 対応:
  - レート制限（429）: 更新頻度を下げる
  - サービス停止（503）: キャッシュで対応
  - タイムアウト: タイムアウト設定見直し

**3. DynamoDBスロットリングアラーム（High）**
- 確認メトリクス: `AWS/DynamoDB > UserErrors`, `SystemErrors`
- 対応:
  - 短期: Lambdaリトライで対応
  - 中期: オンデマンドモード、キャパシティ増加
  - 長期: アクセスパターン見直し、DAX導入

**4. API Gateway 5xx Error Rate Alarm（Critical）**
- 閾値: 5xxエラー率 > 10% for 2分
- エラー種類:
  - 502: Lambda関数エラー
  - 503: 同時実行数制限
  - 504: タイムアウト

**5. API Latency P95 Alarm（Medium）**
- 閾値: P95 > 2秒
- ボトルネック特定: DynamoDB、Lambda、外部API
- 対応: メモリ増加、DAX導入、キャッシュ調整

**6. Lambda Throttle Alarm（High）**
- 閾値: スロットル > 10回 in 1分
- 対応: 同時実行数増加、Provisioned Concurrency

#### ロールバック判断基準

**自動ロールバック:**
- Lambda error rate > 5% for 2分
- API Gateway 5xx rate > 10% for 2分
- Lambda throttle count > 10 in 1分

**手動ロールバック:**
- デプロイ直後（10分以内）の問題
- 長期的な問題（エラー率3%以上だが閾値未満）
- 機能的な問題（エラーなしだが動作不正）

#### よくある問題と対処法
- 外部APIレート制限
- DynamoDBホットパーティション
- Lambdaコールドスタート
- APIキー漏洩

#### エスカレーションフロー
- レベル1: 運用担当者（初動対応）
- レベル2: 開発チーム（技術調査）
- レベル3: マネジメント（意思決定）

---

### 4. API Versioning / Backward Compatibility セクションの追加

**目的:**
今後APIを変更する際に、破壊的変更を避けるルールを先に決めておく。

**基本方針:**
1. 既存バージョンでは破壊的変更を行わない
2. 後方互換な変更は同じバージョンで実施可能
3. 破壊的変更が必要な場合は新バージョンを作成

**現在のバージョン戦略:**
- 初期エンドポイント: `/prices`（バージョンなし）
- 暗黙的にv1として扱う
- 将来的に`/v2/prices`を追加する可能性

**破壊的変更の定義:**
1. 既存フィールドの削除
2. 既存フィールドの型変更
3. 既存フィールドの意味変更
4. 必須パラメータの追加
5. エンドポイントパスの変更
6. 認証方式の変更

**後方互換な変更:**
1. 新フィールドの追加（クライアントは無視可能）
2. オプショナルパラメータの追加
3. エラーメッセージの改善
4. パフォーマンス最適化
5. 新しいエンドポイントの追加

**バージョン移行手順:**
1. 新バージョンの設計・実装（`/v2/prices`）
2. 並行稼働期間の設定（最低3ヶ月）
3. クライアントへの通知（非推奨警告）
4. 段階的な移行
5. 旧バージョンの廃止

**ベストプラクティス:**
- ドキュメントの明確化
- 非推奨の明示（レスポンスヘッダー）
- テストの維持
- 監視とメトリクス

---

## 追加されたタスク

### タスク22: セキュリティ・コンプライアンスポリシーの実装
- ログマスキング機能（APIキー、IPアドレス）
- 構造化JSONログフォーマット
- CloudWatch Logs保持期間設定（環境ごと）
- DynamoDB TTL設定
- APIキー`lastUsedAt`属性
- 監査ログ記録

### タスク23: APIバージョニング対応の準備
- 将来的なフィールド追加を考慮した設計
- バージョニング戦略の文書化
- 後方互換性テスト
- 非推奨警告の仕組み

### タスク24: 運用ドキュメントとアラート対応フローの整備
- operations.mdの共有
- アラート対応手順の確認
- Slack/Email通知設定
- アラート対応訓練

---

## 実装への影響

### 既存タスクへの影響
- 既存のタスク1-21は変更なし
- 新規タスク22-24を追加

### 新規に必要な作業
- セキュリティポリシーの実装（タスク22）
- APIバージョニング対応（タスク23）
- 運用ドキュメント整備（タスク24）

### 推奨される実装順序
1. タスク1-21: コア機能の実装（既存計画通り）
2. タスク22: セキュリティポリシー実装
3. タスク23: APIバージョニング対応
4. タスク24: 運用ドキュメント整備

---

## 設計方針の確認

### IPアドレスのログ記録
- **API Gatewayログ**: 記録される（オペレーション用途のみ参照）
- **アプリケーションログ**: 記録しない

### ユーザーID
- **現在**: 実装しない（APIキーのみ）
- **将来**: APIキーとユーザー/テナントの紐付けを検討

### データ保持期間
- **DynamoDB**: 価格データ（1時間）、レート制限（1時間）、APIキー（永続）
- **CloudWatch Logs**: 環境ごとに異なる（dev: 30日、staging: 60日、prod: 90日）
- **調整可能**: 監査要件に応じて変更

### APIバージョニング
- **初期**: `/prices`（バージョンなし）
- **将来**: `/v2/prices`を追加（破壊的変更が必要な場合）
- **並行稼働**: 最低3ヶ月

### 通知チャネル
- **現在**: Slack + Email（SNS経由）
- **将来**: PagerDuty/Opsgenieも検討

---

## 完了条件

### Security / Compliance
- [x] ログポリシーを1-2ページで明文化
- [x] データ保持ポリシーを明文化
- [x] 監査ログイベントを明文化
- [x] APIキー運用方針を明文化

### Out of Scope / Future Work
- [x] 今回のスコープ外を明確化
- [x] 将来拡張の方向性を文章化
- [x] 現在設計が「現在価格のみ」に最適化されていることを明示

### 運用Runbook
- [x] 主要なアラート種別と意味を記載
- [x] アラートごとの初動対応ステップを記載
- [x] ロールバック判断基準を記載
- [x] 「見る場所」と「順番」を明記

### API Versioning
- [x] 基本方針を明文化
- [x] 破壊的変更の定義を明文化
- [x] フィールド追加・変更のルールを明文化
- [x] バージョン移行手順を明文化

---

## 次のステップ

1. ✅ 仕様改訂完了（第3版）
2. ⏭️ タスク1から順次実装開始
3. ⏭️ タスク22-24を適切なタイミングで実装
4. ⏭️ operations.mdをチームに共有し、アラート対応訓練を実施
5. ⏭️ セキュリティポリシーを実装に反映
6. ⏭️ APIバージョニング戦略をドキュメント化

---

## 承認

- [x] ユーザー要件を反映
- [x] 設計書を更新（Security/Compliance、Out of Scope、Future Work、API Versioning）
- [x] 運用ドキュメント（operations.md）を新規作成
- [x] タスクリストを更新（タスク22-24追加）
- [x] CHANGELOGを更新
- [x] 整合性を確認

**ステータス: 承認済み - 実装開始可能**
