# 要件定義書

## はじめに

Crypto Watch Flutterフロントエンドは、スマートウォッチクライアント向けに最適化された暗号通貨価格監視アプリケーションです。バックエンドAPIから価格データを取得し、ユーザーフレンドリーなインターフェースで表示します。

## 用語集

- **システム**: Crypto Watch Flutterアプリケーション
- **ユーザー**: アプリケーションを使用する人
- **バックエンドAPI**: 暗号通貨価格データを提供するAWS Lambda API
- **暗号通貨**: ビットコイン、イーサリアムなどのデジタル通貨
- **価格データ**: シンボル、名前、価格、24時間変動率、時価総額を含むデータ
- **APIキー**: バックエンドAPIへのアクセスに必要な認証トークン
- **リフレッシュ**: 最新の価格データを取得する操作
- **エラー状態**: ネットワークエラーやAPI障害が発生した状態
- **ローディング状態**: データ取得中の状態

## 要件

### 要件1: 価格データの表示

**ユーザーストーリー**: ユーザーとして、複数の暗号通貨の現在価格を一覧で確認したい。そうすることで、市場の動向を素早く把握できる。

#### 受入基準

1. WHEN システムが起動する THEN システムは自動的に価格データを取得し表示する
2. WHEN 価格データが表示される THEN システムは各暗号通貨のシンボル、名前、現在価格、24時間変動率を表示する
3. WHEN 24時間変動率が正の値である THEN システムは緑色で変動率を表示する
4. WHEN 24時間変動率が負の値である THEN システムは赤色で変動率を表示する
5. WHEN 価格データが表示される THEN システムは価格を適切な桁数でフォーマットする（例：¥1,234,567）

### 要件2: 手動リフレッシュ機能

**ユーザーストーリー**: ユーザーとして、最新の価格データを手動で取得したい。そうすることで、必要なタイミングで最新情報を確認できる。

#### 受入基準

1. WHEN ユーザーがリフレッシュボタンをタップする THEN システムはバックエンドAPIから最新の価格データを取得する
2. WHEN ユーザーが画面を下にスワイプする THEN システムはプルトゥリフレッシュ操作を実行する
3. WHEN リフレッシュ操作が実行される THEN システムはローディングインジケーターを表示する
4. WHEN データ取得が完了する THEN システムはローディングインジケーターを非表示にし、新しいデータを表示する
5. WHEN リフレッシュ中にユーザーが再度リフレッシュを試みる THEN システムは重複リクエストを防止する

### 要件3: 自動更新機能

**ユーザーストーリー**: ユーザーとして、価格データが自動的に更新されることを期待する。そうすることで、常に最新の情報を確認できる。

#### 受入基準

1. WHEN アプリがフォアグラウンドにある THEN システムは30秒ごとに価格データを自動更新する
2. WHEN アプリがバックグラウンドに移行する THEN システムは自動更新を停止する
3. WHEN アプリがフォアグラウンドに戻る THEN システムは自動更新を再開し、即座にデータを取得する
4. WHEN 自動更新が実行される THEN システムはユーザーの操作を妨げない
5. WHEN 自動更新中にエラーが発生する THEN システムは次の更新サイクルまで待機する

### 要件4: エラーハンドリング

**ユーザーストーリー**: ユーザーとして、ネットワークエラーやAPI障害が発生した際に適切なフィードバックを受け取りたい。そうすることで、問題を理解し適切に対応できる。

#### 受入基準

1. WHEN ネットワーク接続がない THEN システムは「ネットワーク接続がありません」というメッセージを表示する
2. WHEN APIがエラーレスポンスを返す THEN システムは適切なエラーメッセージを表示する
3. WHEN 認証エラーが発生する THEN システムは「APIキーが無効です」というメッセージを表示する
4. WHEN レート制限エラーが発生する THEN システムは「リクエスト制限に達しました。しばらくお待ちください」というメッセージを表示する
5. WHEN エラーメッセージが表示される THEN システムは再試行ボタンを提供する

### 要件5: ローディング状態の表示

**ユーザーストーリー**: ユーザーとして、データ取得中であることを視覚的に確認したい。そうすることで、アプリが正常に動作していることを理解できる。

#### 受入基準

1. WHEN 初回データ取得が開始される THEN システムは画面中央にローディングインジケーターを表示する
2. WHEN リフレッシュ操作が実行される THEN システムはプルトゥリフレッシュインジケーターを表示する
3. WHEN データ取得が完了する THEN システムはローディングインジケーターを非表示にする
4. WHEN データ取得中にエラーが発生する THEN システムはローディングインジケーターを非表示にし、エラーメッセージを表示する
5. WHEN ローディング状態である THEN システムはユーザーが他の操作を実行できるようにする

### 要件6: APIクライアントの実装

**ユーザーストーリー**: 開発者として、バックエンドAPIと通信するための堅牢なクライアントが必要である。そうすることで、信頼性の高いデータ取得が可能になる。

#### 受入基準

1. WHEN APIクライアントが初期化される THEN システムはAPIキーと基底URLを設定する
2. WHEN 価格データをリクエストする THEN システムは適切なHTTPヘッダー（X-API-Key、Accept-Encoding）を含める
3. WHEN APIレスポンスを受信する THEN システムはJSONデータを適切なDartオブジェクトにパースする
4. WHEN HTTPエラーが発生する THEN システムは適切な例外をスローする
5. WHEN タイムアウトが発生する THEN システムはタイムアウト例外をスローする

### 要件7: データモデルの定義

**ユーザーストーリー**: 開発者として、型安全なデータモデルが必要である。そうすることで、バグを減らし保守性を向上できる。

#### 受入基準

1. WHEN 価格データを扱う THEN システムはCryptoPriceモデルクラスを使用する
2. WHEN JSONからモデルを生成する THEN システムはfromJsonファクトリーコンストラクタを使用する
3. WHEN モデルをJSONに変換する THEN システムはtoJsonメソッドを使用する
4. WHEN 必須フィールドが欠落している THEN システムは適切な例外をスローする
5. WHEN モデルが生成される THEN システムはすべてのフィールドをイミュータブルにする

### 要件8: 設定管理

**ユーザーストーリー**: 開発者として、APIキーやエンドポイントURLを安全に管理したい。そうすることで、セキュリティを確保し環境ごとの設定を容易にできる。

#### 受入基準

1. WHEN アプリが起動する THEN システムは環境変数または設定ファイルからAPIキーを読み込む
2. WHEN APIキーが設定されていない THEN システムは適切なエラーメッセージを表示する
3. WHEN 開発環境と本番環境を切り替える THEN システムは適切なAPIエンドポイントを使用する
4. WHEN 設定を変更する THEN システムはアプリの再起動なしに変更を反映する
5. WHEN APIキーをログに出力する THEN システムはマスキングされた値を出力する

### 要件9: UIの最適化

**ユーザーストーリー**: ユーザーとして、スマートウォッチでも読みやすいシンプルなUIを期待する。そうすることで、小さな画面でも快適に使用できる。

#### 受入基準

1. WHEN UIが表示される THEN システムは大きく読みやすいフォントを使用する
2. WHEN 価格リストが表示される THEN システムは各アイテムに十分な余白を確保する
3. WHEN ダークテーマが適用される THEN システムは黒背景に白または明るい色のテキストを使用する
4. WHEN 重要な情報を表示する THEN システムは視覚的な階層を明確にする
5. WHEN タップ可能な要素を配置する THEN システムは十分なタップ領域を確保する

### 要件10: パフォーマンスの最適化

**ユーザーストーリー**: ユーザーとして、アプリが高速に動作することを期待する。そうすることで、ストレスなく使用できる。

#### 受入基準

1. WHEN 価格リストをスクロールする THEN システムは60FPSを維持する
2. WHEN データを取得する THEN システムは不要な再描画を避ける
3. WHEN 画像やアイコンを表示する THEN システムはキャッシュを活用する
4. WHEN メモリ使用量が増加する THEN システムは適切にリソースを解放する
5. WHEN アプリが起動する THEN システムは3秒以内に初期画面を表示する

### 要件11: お気に入り銘柄管理

**ユーザーストーリー**: ユーザーとして、自分がウォッチしたい銘柄を登録・管理したい。そうすることで、関心のある銘柄だけを効率的に追跡できる。

#### 受入基準

1. WHEN ユーザーが銘柄を選択する THEN システムはお気に入りリストに追加するオプションを提供する
2. WHEN お気に入りリストが表示される THEN システムは登録された銘柄のみを表示する
3. WHEN ユーザーが銘柄を長押しする THEN システムはドラッグ＆ドロップで並び替えを可能にする
4. WHEN ユーザーが銘柄の順序を変更する THEN システムは変更をローカルストレージに永続化する
5. WHEN お気に入りリストが空である THEN システムは「銘柄を追加してください」というメッセージを表示する

### 要件12: 詳細価格情報の表示

**ユーザーストーリー**: ユーザーとして、各銘柄の詳細な価格情報を確認したい。そうすることで、より深い市場分析ができる。

#### 受入基準

1. WHEN 銘柄をタップする THEN システムは詳細画面に遷移する
2. WHEN 詳細画面が表示される THEN システムは現在価格、24時間変動率、高値、安値、出来高を表示する
3. WHEN 詳細画面が表示される THEN システムは1時間、24時間、7日間のミニチャートを表示する
4. WHEN チャート期間を切り替える THEN システムは選択された期間のデータを表示する
5. WHEN 詳細画面からお気に入りに追加する THEN システムはワンタップで追加できるボタンを提供する

### 要件13: シングルビューモード

**ユーザーストーリー**: ユーザーとして、1つの銘柄だけを大きく表示したい。そうすることで、スマートウォッチの小さな画面でも価格を素早く確認できる。

#### 受入基準

1. WHEN ユーザーがシングルビューモードを選択する THEN システムは1つの銘柄のみを全画面表示する
2. WHEN シングルビューが表示される THEN システムは大きなフォントで価格と変動率を表示する
3. WHEN シングルビューが表示される THEN システムはミニチャートを含める
4. WHEN ユーザーが左右にスワイプする THEN システムは次/前のお気に入り銘柄に切り替える
5. WHEN シングルビューモードである THEN システムは自動更新を継続する

### 要件14: コンプリケーション対応

**ユーザーストーリー**: ユーザーとして、スマートウォッチの文字盤上で価格を確認したい。そうすることで、アプリを開かずに最新価格を把握できる。

#### 受入基準

1. WHEN 小サイズのコンプリケーションが表示される THEN システムは価格のみを表示する
2. WHEN 中サイズのコンプリケーションが表示される THEN システムは価格と変動率を表示する
3. WHEN 大サイズのコンプリケーションが表示される THEN システムは価格、変動率、ティッカー名を表示する
4. WHEN コンプリケーションをタップする THEN システムはアプリを起動し該当銘柄の詳細を表示する
5. WHEN コンプリケーションが更新される THEN システムは最新の価格データを反映する

### 要件15: 表示通貨の切り替え

**ユーザーストーリー**: ユーザーとして、価格を異なる通貨で表示したい。そうすることで、自分の好みの通貨で価格を確認できる。

#### 受入基準

1. WHEN ユーザーが設定画面を開く THEN システムは通貨選択オプションを提供する
2. WHEN ユーザーが通貨を選択する THEN システムはJPY、USD、EUR、BTCから選択できる
3. WHEN 通貨が変更される THEN システムはすべての価格表示を選択された通貨に変換する
4. WHEN 通貨設定が保存される THEN システムは次回起動時も同じ通貨を使用する
5. WHEN 通貨変換レートが必要である THEN システムは適切な為替レートまたはBTC換算レートを適用する

### 要件16: アラート機能

**ユーザーストーリー**: ユーザーとして、特定の価格に達したときに通知を受け取りたい。そうすることで、重要な価格変動を見逃さない。

#### 受入基準

1. WHEN ユーザーが詳細画面でアラート設定を開く THEN システムは目標価格を入力できるフォームを表示する
2. WHEN ユーザーがアラートを設定する THEN システムは上限価格と下限価格の両方を設定できる
3. WHEN 価格が設定値に達する THEN システムはプッシュ通知を送信する
4. WHEN アラートが発火する THEN システムは通知をタップすると該当銘柄の詳細画面を開く
5. WHEN ユーザーがアラートを削除する THEN システムは確認ダイアログを表示する

### 要件17: シンプルな一覧レイアウト

**ユーザーストーリー**: ユーザーとして、スマートウォッチの小さな画面で見やすい一覧を期待する。そうすることで、一目で複数の銘柄を確認できる。

#### 受入基準

1. WHEN 一覧画面が表示される THEN システムは1画面に3〜5銘柄を表示する
2. WHEN 各銘柄が表示される THEN システムはティッカー、価格、24時間変動率のみを表示する
3. WHEN ユーザーが上下にスクロールする THEN システムは追加の銘柄を表示する
4. WHEN 銘柄アイテムが表示される THEN システムは大きめのフォントと十分な余白を確保する
5. WHEN 一覧が長い THEN システムはスムーズなスクロールを提供する
